{"versionid":"b36cf1f5-b7ef-41c6-9e50-61eb4955cb43","workflowid":"cpLFiCzhIKpRmgbA","createdat":"2025-11-06T05:37:18.039Z","updatedat":"2025-11-06T05:37:18.039Z","nodes":[{"parameters":{"httpMethod":"POST","path":"3cd450b1-240c-480b-b2ce-d47bc5cc12f5","authentication":"headerAuth","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[848,-192],"id":"c2e3a8ee-ebbf-4b92-aafa-7113d94a5f7c","name":"Webhook","webhookId":"3cd450b1-240c-480b-b2ce-d47bc5cc12f5","credentials":{"httpHeaderAuth":{"id":"57meP85zPL4JYI7T","name":"Header Auth account"}}},{"parameters":{"resource":"user","operation":"getAll","path":"888af8aa-7efe-47be-90bd-9a70dabcc317"},"type":"n8n-nodes-base.slack","typeVersion":2.3,"position":[1280,-192],"id":"c1073d36-1632-486c-887d-117cd1feff0c","name":"getUsers","webhookId":"888af8aa-7efe-47be-90bd-9a70dabcc317","executeOnce":true,"credentials":{"slackApi":{"id":"qPNRJ2gYNvlnyMvR","name":"Slack - Nathan - User OAuth Token"}}},{"parameters":{"resource":"channel","operation":"getAll","filters":{},"path":"67fbbfda-65e0-41f9-a099-19680420e3ba"},"type":"n8n-nodes-base.slack","typeVersion":2.3,"position":[1072,-192],"id":"238570a5-2170-4974-817d-8f3c339d355e","name":"getChannels","webhookId":"67fbbfda-65e0-41f9-a099-19680420e3ba","credentials":{"slackApi":{"id":"qPNRJ2gYNvlnyMvR","name":"Slack - Nathan - User OAuth Token"}}},{"parameters":{"jsCode":"// Get all users\nconst users = $input.all();\n\n// Filter to only active, non-bot, non-guest users\nconst filteredUsers = users.filter(item => {\n  const user = item.json;\n  \n  return (\n    !user.deleted &&           // Not deleted\n    !user.is_bot &&            // Not a bot\n    !user.is_restricted &&     // Not a guest\n    user.id !== 'USLACKBOT'    // Not Slackbot itself\n  );\n});\n\n// Remove duplicates by ID using a Map\nconst uniqueUsersMap = new Map();\n\nfilteredUsers.forEach(item => {\n  const userId = item.json.id;\n  // Only add if we haven't seen this ID before\n  if (!uniqueUsersMap.has(userId)) {\n    uniqueUsersMap.set(userId, item);\n  }\n});\n\n// Convert Map back to array\nconst uniqueUsers = Array.from(uniqueUsersMap.values());\n\nreturn uniqueUsers;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1488,-192],"id":"b86fa45f-4bf1-40da-821a-dbb7360a4f67","name":"realUsers"},{"parameters":{"jsCode":"// Get channels and users from previous nodes\nconst channels = $('getChannels').all();\nconst users = $('realUsers').all();\n// Get the user's message from the webhook\nconst userMessage = $('Webhook').first().json.body.text;\n\n// Format channels for AI context - only include relevant fields\nconst formattedChannels = channels.map(item => ({\n  id: item.json.id,\n  name: item.json.name,\n  is_private: item.json.is_private || false\n}));\n\n// Format users for AI context - only include relevant fields\nconst formattedUsers = users.map(item => ({\n  id: item.json.id,\n  name: item.json.real_name || item.json.name,\n  display_name: item.json.profile?.display_name || ''\n}));\n\n// Return single item with all context for the AI\nreturn [{\n  json: {\n    channels: formattedChannels,\n    users: formattedUsers,\n    userMessage: userMessage,\n    timestamp: new Date().toISOString()\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[848,0],"id":"91ed16a7-d443-448b-b11d-6db1ca8fdfd6","name":"agentSetup"},{"parameters":{"promptType":"define","text":"=You are a Slack message router for voice commands.\n\nAVAILABLE CHANNELS:\n{{JSON.stringify($json.channels, null, 2)}}\n\nAVAILABLE USERS:\n{{JSON.stringify($json.users, null, 2)}}\n\nUser command: \"{{$json.userMessage}}\"\n\nCRITICAL INSTRUCTIONS:\n1. Find the recipient by matching the name. The user must be matched to the list of AVAILABLE USERS\n2. Use the EXACT ID from the lists above - do NOT make up or modify IDs\n3. Extract the message content\n4. Return ONLY the JSON object below (no markdown, no explanation)\n\nIf the recipient name matches a user, find that user in the AVAILABLE USERS list and use their exact \"id\" field.\nIf the recipient name matches a channel, find that channel in the AVAILABLE CHANNELS list and use their exact \"id\" field.\nIf no match is found, set type to \"error\".\n\nReturn this exact structure with the ACTUAL IDs from the lists:\n{\"type\":\"user\",\"recipientId\":\"EXACT_ID_FROM_LIST\",\"recipientName\":\"matched name\",\"message\":\"extracted message\"}\n\nDo NOT invent or shorten IDs. Use the complete ID exactly as shown in the available lists.","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[1056,0],"id":"c626bec7-7070-4867-991f-44f2baa362f4","name":"AI Agent"},{"parameters":{"model":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"gpt-4o-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[992,240],"id":"0352f2b3-64d7-4d54-9462-aefb0ba33b1f","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"ZIhKmLFbnV3eHkVn","name":"OpenAi SDL(personal)"}}},{"parameters":{"jsCode":"// Get the AI output string\nlet outputString = $json.output;\n\n// Parse the JSON string\nlet parsed = JSON.parse(outputString);\n\n// Return the parsed object\nreturn [{\n  json: parsed\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1392,0],"id":"ea6c3784-5306-4333-94be-959d8b703dab","name":"postProcess"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"f9dd7993-be12-44d3-8070-551e9196fb06","leftValue":"={{ $json.type }}","rightValue":"user","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1600,0],"id":"c94c0e0f-d42d-489e-a613-46f3b18ada8c","name":"ifUser"},{"parameters":{"select":"user","user":{"__rl":true,"value":"={{ $json.recipientId }}","mode":"id"},"text":"={{ $('postProcess').item.json.message }}","otherOptions":{"includeLinkToWorkflow":false,"sendAsUser":"luke"},"path":"6ae02cba-eea0-4cee-9c61-0c2691e7f502"},"type":"n8n-nodes-base.slack","typeVersion":2.3,"position":[1808,-112],"id":"d07d4e45-e2dd-4837-818d-a95dc5d6ebee","name":"Send a message","webhookId":"6ae02cba-eea0-4cee-9c61-0c2691e7f502","credentials":{"slackApi":{"id":"qPNRJ2gYNvlnyMvR","name":"Slack - Nathan - User OAuth Token"}}},{"parameters":{"select":"channel","channelId":{"__rl":true,"value":"={{ $json.recipientId }}","mode":"id"},"text":"={{ $('postProcess').item.json.message }}","otherOptions":{"includeLinkToWorkflow":false,"sendAsUser":"luke"},"path":"1dab1806-aed6-4670-9d1f-d7fecc258c63"},"type":"n8n-nodes-base.slack","typeVersion":2.3,"position":[1808,112],"id":"108548f4-65ad-4d27-9de5-1724834e5bb2","name":"Post to Channel","webhookId":"1dab1806-aed6-4670-9d1f-d7fecc258c63","credentials":{"slackApi":{"id":"qPNRJ2gYNvlnyMvR","name":"Slack - Nathan - User OAuth Token"}}},{"parameters":{"content":"## Version Control\n\n2025-09-04 12:42 - initial creation, split from main to run wait-limited concurrent flows\n2025-09-04 12:49 - converted workflow variables into an object that I can pass to sub workflows","height":480,"width":844,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-64,-144],"id":"dc168cfe-ad9b-4fd4-9f5b-1c004f62576c","name":"Sticky Note3"},{"parameters":{"content":"# 001.0 - Trigger Workflow","height":80,"width":836,"color":3},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-64,-240],"id":"49efea07-ed6b-4aea-9b7e-5834854d6e2d","name":"Sticky Note"},{"parameters":{"respondWith":"json","responseBody":"={\n  \"message\": \"âœ… Sent: {{ $('postProcess').item.json.message }} to {{ $('postProcess').item.json.recipientName }}\n}","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.4,"position":[2208,0],"id":"dd63e963-bf0d-44a8-b8d1-0174fff4b1c5","name":"Respond to Webhook"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2016,0],"id":"692b5b5c-c594-45bc-a3d5-2d2efc50d006","name":"."}],"connections":{"Webhook":{"main":[[{"node":"getChannels","type":"main","index":0}]]},"getChannels":{"main":[[{"node":"getUsers","type":"main","index":0}]]},"getUsers":{"main":[[{"node":"realUsers","type":"main","index":0}]]},"realUsers":{"main":[[{"node":"agentSetup","type":"main","index":0}]]},"agentSetup":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"AI Agent":{"main":[[{"node":"postProcess","type":"main","index":0}]]},"postProcess":{"main":[[{"node":"ifUser","type":"main","index":0}]]},"ifUser":{"main":[[{"node":"Send a message","type":"main","index":0}],[{"node":"Post to Channel","type":"main","index":0}]]},"Send a message":{"main":[[{"node":".","type":"main","index":0}]]},"Post to Channel":{"main":[[{"node":".","type":"main","index":0}]]},".":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"workflow_name":"Read Slack Messages Handsfree"}